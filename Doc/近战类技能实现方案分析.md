# 近战类技能实现方案分析

## 目前的战斗伤害结算流程
1. 由伤害来源的技能向伤害对象发送受伤事件（包含伤害来源的坐标，伤害的类型，伤害的基础数值等信息）。
2. 由伤害对象通过收到的受伤事件包含的信息叠加自身效果（如免伤/减伤技能）算出伤害的最终数值并完成扣血。

**分析**：

1. 结算流程是**单向**的：伤害来源->伤害对象
2. 伤害对象（给谁发送受伤信息）由伤害来源确定：因为目前没有接口能获取其他玩家的坐标信息，所以只能通过碰撞体来获取伤害对象。
3. 受伤事件的发送顺序也由伤害来源确定，但伤害来源在发送受伤事件时无法控制受伤事件的结算顺序。因为实际结算由各个受伤对象负责，各个玩家是独立（并发）的；伤害来源发送事件也无回调（伤害对象并不会通知伤害来源已经完成了受伤信息的结算）。

## 常见近战类技能

### 劈砍类
#### 方案一
**效果**：使用后朝角色正面X距离造成一个扇形攻击。

**变量**：原点、方向、半径、半角、竖直高度

**伤害对象**：
1. 以角色为扇形立柱（底面为扇形的柱体）的顶点，生成扇形立柱形状的碰撞体，碰到的即为受伤对象

2. 以角色为立方体底面中心（边长为二倍扇形半径），从碰到的对象中筛查受伤对象（计算距离和角度是否符合条件）

**特点**：与动画效果无关，可能会产生误判。攻击范围稳定，容易操控。

#### 方案二

**变量**：武器碰撞体（武器表面/简化后的武器表面）

**伤害对象**：碰到的即为伤害对象

**特点**：所见即所得，不会产生误判。攻击范围不稳定，取决于动画，不容易操控。

### 突刺类
#### 方案一
**效果**：朝鼠标指向一个点进行X米的穿刺类攻击，允许/不允许刺穿（只对第一个打到的对象造成伤害）。

**变量**：原点、方向、距离、判定时机

**伤害对象**：在攻击动画的其中一瞬间从角色手部沿突刺方向发射Ray获取伤害对象（是否允许刺穿可在Ray返回碰到的对象时做进一步的设置）

**特点**：和激光枪类武器的实现相同。与动画效果无关，可能会产生误判。攻击范围稳定，容易操控。

#### 方案二

**效果**：朝鼠标指向一个点进行X米的穿刺类攻击，允许刺穿（在路径上的对象均造成伤害）。

**变量**：武器碰撞体（武器表面/简化后的武器表面）

**伤害对象**：碰到的即为受伤对象

**特点**：所见即所得，不会产生误判。攻击范围不稳定，取决于动画，不容易操控。

### 防御类
#### 对于持盾角色
**效果**：使用时在角色中心正前方形成一面圆形盾牌，可以阻挡或者减少穿过盾的伤害。

**变量**：原点、半角、减伤折扣指数

**减伤判定**：如果伤害来源和伤害对象的相对位置矢量和伤害对象前进方向矢量的夹角小于半角，给予减伤。

**特点**：与动画效果无关，可能会产生误判。防御范围稳定，容易操控。

#### 对于持盾角色身后的角色

**效果**：对技能攻击路径上穿过其他玩家的盾再攻击到的角色进行减伤

**变量**：原点

**减伤判定**：使用Ray获取伤害对象和伤害来源之间的所有盾（需设置盾碰撞体和数据模块以便通过碰撞获取盾的减伤数值）进行减伤效果叠加。给盾设置tag，筛选时使用mask，提升效率。

**特点**：即使在受伤事件无顺序群发的状态下依旧可以运算出稳定正确的效果。在结算伤害时多增加了一个阶段，增加了运算负担（主要在于相交测试），建议只对部分小范围技能允许攻击路径上有盾的伤害减免。所见即所得，不会产生误判。减伤范围不稳定，取决于动画，不容易操控。